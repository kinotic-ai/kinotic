# Helm Values for structures-server deployment in KinD
# This file provides sensible defaults for local development and testing.
# User-specific overrides can be placed in helm-values.local.yaml (gitignored).
#
# ⚠️ BASED ON WORKING CLUSTER CONFIG:
# - structures-core/src/test/resources/application-test.yml (YAML format)
# - structures-core/src/test/resources/docker-compose/cluster-test-compose.yml (ENV vars)
#
# Key differences from docker-compose SHAREDFS setup:
# - discoveryType: KUBERNETES (not SHAREDFS)
# - No localAddresses needed (Kubernetes DNS handles discovery)
# - No sharedFsPath needed (Kubernetes handles network coordination)

# ============================================================================
# BEFORE DEPLOYING: BUILD AND LOAD THE IMAGE
# ============================================================================
# 1. Build the image:
#    ./gradlew :structures-server:bootBuildImage
#
# 2. Load into KinD cluster:
#    kind load docker-image kinoticai/structures-server:3.5.1-SNAPSHOT --name structures-cluster
#
# OR use the helper script:
#    ./dev-tools/kind/kind-cluster.sh build --load
# ============================================================================

# Number of structures-server replicas (3 for testing HA and cluster coordination)
replicaCount: 3
nameOverride: ""

# Image configuration
image:
  # Repository matches bootBuildImage output
  repository: kinoticai/structures-server
  # Tag from gradle.properties version (structuresVersion=3.5.1-SNAPSHOT)
  tag: 3.5.2
  # Never pull - use images loaded into KinD cluster
  pullPolicy: Never
  sha: ""

# Migration configuration
# Runs as a Helm pre-install/pre-upgrade hook Job.
# The migration must complete successfully before the Deployment is rolled out.
migration:
  backoffLimit: 3
  activeDeadlineSeconds: 300
  image:
    repository: kinoticai/structures-migration
    tag: 3.5.2
    # Never pull - use images loaded into KinD cluster
    pullPolicy: Never
    sha: ""

## eviction-tracking uses the evictionTracking logic and paths for tracking eviction events
properties:
  springActiveProfiles: "production,debug,eviction-tracking"
  corsAllowedOriginPattern: "*"
  enableJmx: true
  enableNmt: true
  javaToolOptions: "-Djava.net.preferIPv4Stack=true -XX:MaxDirectMemorySize=512m" ## -javaagent:/workspace/BOOT-INF/classes/opentelemetry-javaagent.jar 
  bplJvmHeadRoom: 10
  structures:
    tenantIdFieldName: "tenantId"
    indexPrefix: "struct_"
    openApiSecurityType: "BASIC"
    openApiPort: 8080
    openApiPath: "/api/"
    openApiServerUrl: "https://structures.local/"
    graphqlPort: 4000
    graphqlPath: "/graphql/"
    webServerPort: 9090
    healthCheckPath: "/health"
    enableStaticFileServer: true
    initializeWithSampleData: false
    elastic:
      connections:
        - host: "elasticsearch-master"  # Internal Elasticsearch service deployed in KinD
          port: 9200
          scheme: "http"  # No SSL for local development
      connectionTimeout: "5s"
      socketTimeout: "60s"
      username: ""  # No auth for local development
      password: ""
    ai:
      apiKey: "noop"
      baseUrl: "https://api.x.ai"
      model: "grok-4"

continuum_gateway:
  stomp:
    port: 58503
    websocketPath: /v1

continuum:
  debug: true
  disableClustering: false
  maxNumberOfCoresToUse: 4
  maxOffHeapMemory: "419430400"
  stompPort: 58503
  cluster:
    discoveryType: KUBERNETES ## SHAREDFS or KUBERNETES
    joinTimeoutMs: 0
    # Test instance local address: bind to 0.0.0.0 (all interfaces) so containers can reach it
    # Containers connect via host.docker.internal:47500
    localAddress: 0.0.0.0
    # Test instance ports (must be unique from container nodes)
    discoveryPort: 47500      
    communicationPort: 47100 
    # Static IP addresses for all nodes in the cluster
    # Format: host:port,host:port,...
    # localAddresses: null
    # Note: sharedFsPath is still used for Structure data sharing, not for Ignite discovery
    # sharedFsPath: /sharedfs  # Shared with containers via bind mount
    kubernetesNamespace: default
    kubernetesServiceName: structures
    kubernetesIncludeNotReadyAddresses: true
    # kubernetesMasterUrl: ""
    # kubernetesAccountToken: ""

# Ingress configuration - enabled for kind cluster
ingress:
  enabled: true
  className: nginx
  hosts:
    - localhost
    - structures.local
  tls:
    enabled: true
    secretName: structures-tls-secret
    # Set to true when mkcert creates the secret before helm install
    # Set to false to use cert-manager self-signed fallback
    existingSecret: true


# OIDC security service configuration
# Note: authority uses localhost because OIDC flows happen in the browser,
# which accesses Keycloak via the ingress at https://structures.local/auth
oidc:
  debug: true
  frontendConfigurationPath: "/app-config.override.json"
  oidcProviders:
    - provider: "keycloak"
      displayName: "Keycloak"
      enabled: true
      rolesClaimPath: "realm_access.roles"
      domains:
        - "example.com"
      roles:
        - "admin"
      audience: "structures-client"
      clientId: "structures-client"
      authority: "https://structures.local/auth/realms/test"
      redirectUri: "https://structures.local/login"
      postLogoutRedirectUri: "https://structures.local"
      silentRedirectUri: "https://structures.local/silent-renew.html"
    

# Eviction tracking - writes per-pod CSV files to shared host directory
evictionTracking:
  enabled: true
  # Mount path inside the container
  mountPath: "/eviction-data"
  # Host path on KinD nodes (mapped from ./eviction-data on your machine via kind-config.yaml)
  hostPath: "/eviction-data"

nodeSelector: {}
