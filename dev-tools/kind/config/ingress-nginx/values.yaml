# NGINX Ingress Controller Helm Values for KinD
# Chart: ingress-nginx/ingress-nginx
# Repository: https://kubernetes.github.io/ingress-nginx
#
# Configuration for KinD cluster with extraPortMappings on control-plane node
# Includes development-only security relaxations for snippet annotations

controller:
  # KinD-specific: Run on control-plane node where port mappings exist
  nodeSelector:
    ingress-ready: "true"
    kubernetes.io/os: linux

  # Tolerations required to run on control-plane node (which has taints)
  tolerations:
    - key: "node-role.kubernetes.io/master"
      operator: "Exists"
      effect: "NoSchedule"
    - key: "node-role.kubernetes.io/control-plane"
      operator: "Exists"
      effect: "NoSchedule"

  # Use hostPort for KinD (extraPortMappings route traffic here)
  hostPort:
    enabled: true
    ports:
      http: 80
      https: 443

  # Service configuration - use NodePort for KinD
  service:
    type: NodePort

  # Watch all namespaces
  watchIngressWithoutClass: true

  # ⚠️ DEVELOPMENT ONLY - Security relaxations for snippet annotations
  # These settings should NOT be used in production environments as they can
  # allow configuration injection attacks.
  #
  # Required for structures-server ingress which uses configuration-snippet
  # for WebSocket handling and path rewrites.
  #
  # See: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/
  config:
    # Enable configuration-snippet annotation
    allow-snippet-annotations: "true"
    # Allow "risky" directives like proxy_set_header, rewrite, if
    # Acceptable for dev, not for production
    annotations-risk-level: "Critical"

  # Admission webhooks - disable for faster local dev
  admissionWebhooks:
    enabled: false

  # Resource limits for local dev
  resources:
    requests:
      cpu: 100m
      memory: 90Mi
    limits:
      cpu: 500m
      memory: 256Mi

  # Metrics disabled for local dev
  metrics:
    enabled: false

  # Reduce replica count for local dev
  replicaCount: 1

  # Update strategy - recreate for local dev (faster)
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

# Default backend not needed for local dev
defaultBackend:
  enabled: false
