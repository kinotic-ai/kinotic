apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "structures-server.fullname" . }}
data:
  BPL_JVM_HEAD_ROOM: "{{ .Values.properties.bplJvmHeadRoom }}"

  JAVA_TOOL_OPTIONS: "{{ .Values.properties.javaToolOptions }}"
  BPL_JAVA_NMT_ENABLED: "{{ .Values.properties.enableNmt }}"
  BPL_JMX_ENABLED: "{{ .Values.properties.enableJmx }}"
  SPRING_PROFILES_ACTIVE: "{{ .Values.properties.springActiveProfiles }}"

  CONTINUUM_GATEWAY_STOMP_PORT: "{{ .Values.continuum_gateway.stomp.port }}"
  CONTINUUM_GATEWAY_STOMP_WEBSOCKET_PATH: "{{ .Values.continuum_gateway.stomp.websocketPath }}"

  SPRING_AI_OPENAI_BASE_URL: "{{ .Values.properties.structures.ai.baseUrl }}"
  SPRING_AI_OPENAI_CHAT_OPTIONS_MODEL: "{{ .Values.properties.structures.ai.model }}"
  SPRING_AI_OPENAI_API_KEY: "{{ .Values.properties.structures.ai.apiKey }}"

  STRUCTURES_CORS_ALLOWED_ORIGIN_PATTERN: "{{ .Values.properties.corsAllowedOriginPattern }}"
  STRUCTURES_INDEX_PREFIX: "{{ .Values.properties.structures.indexPrefix }}"
  {{ range $index,$value:= .Values.properties.structures.elastic.connections }}
  STRUCTURES_ELASTICCONNECTIONS_{{ $index }}_SCHEME: "{{ $value.scheme }}"
  STRUCTURES_ELASTICCONNECTIONS_{{ $index }}_HOST: "{{ $value.host }}"
  STRUCTURES_ELASTICCONNECTIONS_{{ $index }}_PORT: "{{ $value.port }}"
  {{ end }}
  STRUCTURES_ELASTIC_CONNECTION_TIMEOUT: "{{ .Values.properties.structures.elastic.connectionTimeout }}"
  STRUCTURES_ELASTIC_SOCKET_TIMEOUT: "{{ .Values.properties.structures.elastic.socketTimeout }}"
  STRUCTURES_ELASTIC_USERNAME: "{{ .Values.properties.structures.elastic.username }}"
  STRUCTURES_ELASTIC_PASSWORD: "{{ .Values.properties.structures.elastic.password }}"
  STRUCTURES_OPEN_API_SECURITY_TYPE: "{{ .Values.properties.structures.openApiSecurityType }}"
  STRUCTURES_OPEN_API_PORT: "{{ .Values.properties.structures.openApiPort }}"
  STRUCTURES_OPEN_API_PATH: "{{ .Values.properties.structures.openApiPath }}"
  STRUCTURES_OPEN_API_SERVER_URL: "{{ .Values.properties.structures.openApiServerUrl }}"
  STRUCTURES_GRAPHQL_PORT: "{{ .Values.properties.structures.graphqlPort }}"
  STRUCTURES_GRAPHQL_PATH: "{{ .Values.properties.structures.graphqlPath }}"
  STRUCTURES_WEB_SERVER_PORT: "{{ .Values.properties.structures.webServerPort }}"
  STRUCTURES_HEALTH_CHECK_PATH: "{{ .Values.properties.structures.healthCheckPath }}"
  STRUCTURES_ENABLE_STATIC_FILE_SERVER: "{{ .Values.properties.structures.enableStaticFileServer }}"
  STRUCTURES_INITIALIZE_WITH_SAMPLE_DATA: "{{ .Values.properties.structures.initializeWithSampleData }}"
  STRUCTURES_TENANT_ID_FIELD_NAME: "{{ .Values.properties.structures.tenantIdFieldName }}"
  {{- if .Values.evictionTracking.enabled }}
  # Eviction tracking - path includes ${POD_NAME} which Spring resolves from the POD_NAME env var
  STRUCTURES_CACHE_EVICTION_CSV_PATH: "{{ .Values.evictionTracking.mountPath | default "/eviction-data" }}/evictions-${POD_NAME}.csv"
  {{- end }}
  {{- if .Values.continuum }}
  {{- if .Values.continuum.cluster }}
  # Continuum Cluster Configuration
  # Used to override application YAML configuration for different environments
  # Reference: structures-core/src/test/resources/docker-compose/cluster-test-compose.yml

  CONTINUUM_CLUSTER_DISABLE_CLUSTERING: "{{ .Values.continuum.disableClustering | default "false" }}"
  CONTINUUM_CLUSTER_DISCOVERY_TYPE: "{{ .Values.continuum.cluster.discoveryType | default "LOCAL" | upper }}"
  CONTINUUM_CLUSTER_JOIN_TIMEOUT_MS: "{{ .Values.continuum.cluster.joinTimeoutMs | default "0" }}"
  CONTINUUM_CLUSTER_DISCOVERY_PORT: "{{ .Values.continuum.cluster.discoveryPort | default "47500" }}"
  CONTINUUM_CLUSTER_COMMUNICATION_PORT: "{{ .Values.continuum.cluster.communicationPort | default "47100" }}"
  # Container local address: bind to 0.0.0.0 (all interfaces) for port mapping
  CONTINUUM_CLUSTER_LOCAL_ADDRESS: "{{ .Values.continuum.cluster.localAddress | default "" }}"

  {{- if eq (.Values.continuum.cluster.discoveryType | default "LOCAL" | upper) "KUBERNETES" }}
  # Kubernetes-specific cluster discovery settings
  CONTINUUM_CLUSTER_KUBERNETES_NAMESPACE: "{{ .Values.continuum.cluster.kubernetesNamespace | default "default" }}"
  CONTINUUM_CLUSTER_KUBERNETES_SERVICE_NAME: "{{ .Values.continuum.cluster.kubernetesServiceName | default "structures" }}"
  CONTINUUM_CLUSTER_KUBERNETES_INCLUDE_NOT_READY_ADDRESSES: "{{ .Values.continuum.cluster.kubernetesIncludeNotReadyAddresses | default "false" }}"
  {{- if .Values.continuum.cluster.kubernetesMasterUrl }}
  CONTINUUM_CLUSTER_KUBERNETES_MASTER_URL: "{{ .Values.continuum.cluster.kubernetesMasterUrl }}"
  {{- end }}
  {{- if .Values.continuum.cluster.kubernetesAccountToken }}
  CONTINUUM_CLUSTER_KUBERNETES_ACCOUNT_TOKEN: "{{ .Values.continuum.cluster.kubernetesAccountToken }}"
  {{- end }}
  {{- end }}
  {{- if eq (.Values.continuum.cluster.discoveryType | default "LOCAL" | upper) "SHAREDFS" }}
  # Shared filesystem settings
  CONTINUUM_CLUSTER_SHARED_FS_PATH: "{{ .Values.continuum.cluster.sharedFsPath | default "/sharedfs" }}"
  {{- end }}
  {{- if eq (.Values.continuum.cluster.discoveryType | default "LOCAL" | upper) "LOCAL" }}
  # Local network only clustering settings
  # Format: host:port,host:port,...
  CONTINUUM_CLUSTER_LOCAL_ADDRESSES: "{{ .Values.continuum.cluster.localAddresses | default "" }}"
  {{- end }}
  {{- if .Values.continuum.maxOffHeapMemory }}
  CONTINUUM_MAX_OFF_HEAP_MEMORY: "{{ .Values.continuum.maxOffHeapMemory }}"
  {{- end }}
  {{- if .Values.continuum.debug }}
  CONTINUUM_DEBUG: "{{ .Values.continuum.debug }}"
  {{- end }}
  {{- if .Values.continuum.maxNumberOfCoresToUse }}
  CONTINUUM_MAX_NUMBER_OF_CORES_TO_USE: "{{ .Values.continuum.maxNumberOfCoresToUse }}"
  {{- end }}
  {{- if .Values.continuum.disableClustering }}
  CONTINUUM_DISABLE_CLUSTERING: "{{ .Values.continuum.disableClustering }}"
  {{- end }}
  {{- end }}
  {{- end }}
  {{- if .Values.oidc.enabled }}
  OIDC_SECURITY_SERVICE_ENABLED: "{{ .Values.oidc.enabled }}"
  OIDC_SECURITY_SERVICE_DEBUG: "{{ .Values.oidc.debug }}"
  OIDC_SECURITY_SERVICE_FRONTEND_CONFIGURATION_PATH: "{{ .Values.oidc.frontendConfigurationPath }}"
  {{- range $index,$value:= .Values.oidc.oidcProviders }}
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_PROVIDER: "{{ $value.provider }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_DISPLAY_NAME: "{{ $value.displayName }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_ENABLED: "{{ $value.enabled }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_ROLES_CLAIM_PATH: "{{ $value.rolesClaimPath }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_AUDIENCE: "{{ $value.audience }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_CLIENT_ID: "{{ $value.clientId }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_AUTHORITY: "{{ $value.authority }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_REDIRECT_URI: "{{ $value.redirectUri }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_POST_LOGOUT_REDIRECT_URI: "{{ $value.postLogoutRedirectUri }}"
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_SILENT_REDIRECT_URI: "{{ $value.silentRedirectUri }}"
  {{- range $domainIndex,$domainValue:= $value.domains }}
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_DOMAINS_{{ $domainIndex }}: "{{ $domainValue }}"
  {{- end }}
  {{- range $roleIndex,$roleValue:= $value.roles }}
  OIDC_SECURITY_SERVICE_OIDC_PROVIDERS_{{ $index }}_ROLES_{{ $roleIndex }}: "{{ $roleValue }}"
  {{- end }}
  {{- end }}
  {{- end }}
  