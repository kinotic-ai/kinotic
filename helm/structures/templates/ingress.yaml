{{- if .Values.ingress.enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "structures-server.fullname" . }}
  labels:
    app: {{ include "structures-server.name" . }}
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "structures-affinity"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "10800"
    nginx.ingress.kubernetes.io/session-cookie-change-on-failure: "true"
    # WebSocket timeout configurations - CRITICAL for persistent connections
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"      # 1 hour (time nginx waits for backend response)
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"      # 1 hour (time nginx waits to send to backend)
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"     # 60 seconds (connection establishment)
    nginx.ingress.kubernetes.io/proxy-body-size: "0"            # Unlimited body size for streaming
    nginx.ingress.kubernetes.io/websocket-services: "{{ include "structures-server.fullname" . }}"  # Explicitly enable WebSocket
    # WebSocket-specific headers (ensure proper upgrade)
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"  # Hash by IP for better affinity
    # Conditional rewrite: skip /v1 (WebSocket), rewrite others
    nginx.ingress.kubernetes.io/configuration-snippet: |
      if ($request_uri !~ "^{{ .Values.continuum_gateway.stomp.websocketPath }}") {
        rewrite ^/api(/|$)(.*) /$2 break;
        rewrite ^/graphql(/|$)(.*) /$2 break;
        rewrite ^/()(.*) /$2 break;
      }
      # Ensure WebSocket upgrade headers are properly passed
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_http_version 1.1;
spec:
  ingressClassName: nginx
  rules:
    - http:
        paths:
          # STOMP WebSocket - /v1 forwards to port 58503 (no rewrite)
          - path: {{ .Values.continuum_gateway.stomp.websocketPath }}
            pathType: Prefix
            backend:
              service:
                name: {{ include "structures-server.fullname" . }}
                port:
                  number: {{ .Values.continuum_gateway.stomp.port }}
          
          # API - /api/ forwards to port 8080 (with rewrite)
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ include "structures-server.fullname" . }}
                port:
                  number: {{ .Values.properties.structures.openApiPort }}
          
          # GraphQL - /graphql/ forwards to port 4000 (with rewrite)
          - path: /graphql(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ include "structures-server.fullname" . }}
                port:
                  number: {{ .Values.properties.structures.graphqlPort }}
          
          # UI - root path forwards to port 9090 (with rewrite, catch-all last)
          - path: /()(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ include "structures-server.fullname" . }}
                port:
                  number: {{ .Values.properties.structures.webServerPort }}
{{- end }}
