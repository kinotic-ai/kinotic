{{- if .Values.ingress.enabled -}}
# ============================================================================
# NGINX Ingress Configuration for structures-server
# ============================================================================
#
# This configuration uses FOUR separate Ingress resources:
#   1. WebSocket Ingress - /v1 path for STOMP with sticky sessions
#   2. HTTP Ingress - /api, /graphql paths with standard routing
#   3. Keycloak Ingress - /auth path for OIDC provider (when oidc.enabled)
#   4. Static UI Ingress - / catch-all for SPA
#
# This approach eliminates the need for configuration-snippet annotations
# and prevents nginx directive conflicts.
# ============================================================================

{{- if .Values.oidc.enabled }}
# ----------------------------------------------------------------------------
# Keycloak Ingress - OIDC authentication provider
# ----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "structures-server.fullname" . }}-keycloak
  labels:
    app: {{ include "structures-server.name" . }}
  annotations:
    # Standard HTTP timeouts
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    # Preserve host header for Keycloak
    nginx.ingress.kubernetes.io/proxy-pass-headers: "Location"
    # Allow large headers for OIDC tokens
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    # CRITICAL: Forward headers for HTTPS proxy - tells Keycloak the original protocol
    # This is required when TLS terminates at the ingress and Keycloak runs on HTTP
    nginx.ingress.kubernetes.io/configuration-snippet: |
      proxy_set_header X-Forwarded-Proto https;
      proxy_set_header X-Forwarded-Port 443;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
spec:
  ingressClassName: {{ .Values.ingress.className }}
  {{- if .Values.ingress.tls.enabled }}
  tls:
    - hosts:
        {{- range .Values.ingress.hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .Values.ingress.tls.secretName }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ . | quote }}
      http:
        paths:
          - path: /auth
            pathType: Prefix
            backend:
              service:
                name: keycloak
                port:
                  number: 8888
    {{- end }}
---
{{- end }}

# ----------------------------------------------------------------------------
# WebSocket Ingress - STOMP endpoint with sticky sessions
# ----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "structures-server.fullname" . }}-ws
  labels:
    app: {{ include "structures-server.name" . }}
  annotations:
    # Sticky sessions for WebSocket connections
    nginx.ingress.kubernetes.io/affinity: "cookie"
    nginx.ingress.kubernetes.io/affinity-mode: "persistent"
    nginx.ingress.kubernetes.io/session-cookie-name: "structures-ws-affinity"
    nginx.ingress.kubernetes.io/session-cookie-path: "{{ .Values.continuum_gateway.stomp.websocketPath }}"
    nginx.ingress.kubernetes.io/session-cookie-max-age: "10800"
    nginx.ingress.kubernetes.io/session-cookie-change-on-failure: "true"
    # WebSocket timeout configurations - CRITICAL for persistent connections
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-body-size: "0"
    # WebSocket protocol support - CRITICAL for upgrade
    # nginx-ingress automatically adds Upgrade/Connection headers when proxy-http-version is 1.1
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    nginx.ingress.kubernetes.io/upstream-hash-by: "$remote_addr"
spec:
  ingressClassName: {{ .Values.ingress.className }}
  {{- if .Values.ingress.tls.enabled }}
  tls:
    - hosts:
        {{- range .Values.ingress.hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .Values.ingress.tls.secretName }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ . | quote }}
      http:
        paths:
          - path: {{ $.Values.continuum_gateway.stomp.websocketPath }}
            pathType: Prefix
            backend:
              service:
                name: {{ include "structures-server.fullname" $ }}
                port:
                  number: {{ $.Values.continuum_gateway.stomp.port }}
    {{- end }}
---
# ----------------------------------------------------------------------------
# HTTP Ingress - API and GraphQL (with path rewriting)
# ----------------------------------------------------------------------------
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "structures-server.fullname" . }}-api
  labels:
    app: {{ include "structures-server.name" . }}
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    # Standard HTTP timeouts
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  ingressClassName: {{ .Values.ingress.className }}
  {{- if .Values.ingress.tls.enabled }}
  tls:
    - hosts:
        {{- range .Values.ingress.hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .Values.ingress.tls.secretName }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ . | quote }}
      http:
        paths:
          # API - /api/* forwards to OpenAPI port (rewrite removes /api prefix)
          - path: /api(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ include "structures-server.fullname" $ }}
                port:
                  number: {{ $.Values.properties.structures.openApiPort }}
          # GraphQL - /graphql/* forwards to GraphQL port (rewrite removes /graphql prefix)
          - path: /graphql(/|$)(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: {{ include "structures-server.fullname" $ }}
                port:
                  number: {{ $.Values.properties.structures.graphqlPort }}
    {{- end }}
---
# ----------------------------------------------------------------------------
# Static UI Ingress - Catch-all for SPA (lowest priority)
# ----------------------------------------------------------------------------
# NOTE: This is a separate ingress with Prefix pathType so nginx-ingress
# correctly orders it AFTER more specific paths like /v1, /api, /graphql
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "structures-server.fullname" . }}-ui
  labels:
    app: {{ include "structures-server.name" . }}
  annotations:
    # Standard HTTP timeouts
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "10"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  ingressClassName: {{ .Values.ingress.className }}
  {{- if .Values.ingress.tls.enabled }}
  tls:
    - hosts:
        {{- range .Values.ingress.hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .Values.ingress.tls.secretName }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ . | quote }}
      http:
        paths:
          # Static UI - catch-all for SPA routing (Prefix type = lower priority)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ include "structures-server.fullname" $ }}
                port:
                  number: {{ $.Values.properties.structures.webServerPort }}
    {{- end }}
{{- end }}
